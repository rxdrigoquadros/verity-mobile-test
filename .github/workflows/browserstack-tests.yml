# .github/workflows/browserstack-tests.yml
name: BrowserStack Tests

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'  # Executa toda segunda Ã s 2h

jobs:
  browserstack-tests:
    name: BrowserStack Tests
    runs-on: ubuntu-latest
    if: vars.BROWSERSTACK_ENABLED == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download app
        run: |
          mkdir -p apps
          wget https://github.com/webdriverio/native-demo-app/releases/download/v1.0.8/android.wdio.native.app.v1.0.8.apk -P apps/

      - name: Upload app to BrowserStack
        env:
          BS_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BS_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          # Upload Android app
          response=$(curl -u "$BS_USERNAME:$BS_ACCESS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@apps/android.wdio.native.app.v1.0.8.apk" \
            -F "custom_id=NativeDemoApp")
          
          echo "BrowserStack upload response: $response"
          
          # Extract app_url from response
          app_url=$(echo $response | jq -r '.app_url')
          echo "BROWSERSTACK_APP_ID=$app_url" >> $GITHUB_ENV

      - name: Run BrowserStack tests
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: npm run test:bs

      - name: Generate report
        if: always()
        run: |
          npx allure-commandline generate allure-results --clean -o allure-report

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browserstack-results-${{ github.run_number }}
          path: allure-report/
          retention-days: 30
          if-no-files-found: warn