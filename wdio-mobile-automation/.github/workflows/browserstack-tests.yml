name: BrowserStack Tests

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'  # Executa toda segunda Ã s 2h

jobs:
  browserstack-tests:
    name: BrowserStack Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Upload app to BrowserStack
        env:
          BS_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BS_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          # Upload Android app
          curl -u "$BS_USERNAME:$BS_ACCESS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@apps/Android-NativeDemoApp-0.4.0.apk" \
            -F "custom_id=NativeDemoApp"

      - name: Run BrowserStack tests
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: npm run test:bs

      - name: Generate report
        if: always()
        run: |
          npm install -g allure-commandline
          allure generate allure-results --clean -o allure-report

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browserstack-results
          path: allure-report/
          retention-days: 30